# Makefile for mesh generation

# The MeshVariables file is generated by running make meshes in DPG_ROOT and includes both the definition of several
# variables used below (collection of .msh files) as well as their dependencies on associated .geo files.
include MeshVariables
include MeshVariables_python

# Make targets:
#
# Simply running make does not properly execute the default rule (i.e. 'make meshes_all' must be used instead of 'make')
#
# meshes_all               : generate all meshes
# meshes_update_h          : generates meshes for the update_h      integration tests 
# meshes_L2_proj_*         : generates meshes for the L2 projection integration tests 
# meshes_Advection_test    : generates meshes for the Advection     integration tests 
# meshes_Poisson_test      : generates meshes for the Poisson       integration tests 
# meshes_Euler_test        : generates meshes for the Euler         integration tests 
# meshes_NavierStokes_test : generates meshes for the NavierStokes  integration tests 


PYTHONC   := python3
PYTHONDIR := ../python/
PETERSON_PYTHONDIR := $(PYTHONDIR)peterson_mesh/

SOURCE          := generate_meshes.py
PETERSON_SOURCE := generate_peterson_meshes.py


SHELL := /bin/bash

# Default goal
.PHONY : meshes_all
meshes_all:
	$(MAKE) meshes_update_h
	$(MAKE) meshes_L2_proj_p
	$(MAKE) meshes_L2_proj_h
	$(MAKE) meshes_Advection_test
	$(MAKE) meshes_Poisson_test
	$(MAKE) meshes_Euler_test
	$(MAKE) meshes_NavierStokes_test

.PHONY : meshes_update_h
meshes_update_h : $(UPDATE_H)
$(UPDATE_H) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) update_h $@

.PHONY : meshes_L2_proj_p
meshes_L2_proj_p : $(L2_PROJ_P)
$(L2_PROJ_P) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) L2_proj_p $@

.PHONY : meshes_L2_proj_h
meshes_L2_proj_h : $(L2_PROJ_H)
$(L2_PROJ_H) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) L2_proj_h $@

.PHONY : meshes_Advection_test
meshes_Advection_test : $(ADVECTION_TEST) $(ADVECTION_TEST_PETERSON)
$(ADVECTION_TEST) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) Advection_test $@

$(ADVECTION_TEST_PETERSON): $(PETERSON_PYTHONDIR)/generate_peterson_meshes.py
	cd $(PETERSON_PYTHONDIR) && $(PYTHONC) $(PETERSON_SOURCE)

meshes_Advection_test_Peterson : 

.PHONY : meshes_Poisson_test
meshes_Poisson_test : $(POISSON_TEST)
$(POISSON_TEST) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) Poisson_test $@

.PHONY : meshes_Euler_test
meshes_Euler_test : $(EULER_TEST)
$(EULER_TEST) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) Euler_test $@

.PHONY : meshes_NavierStokes_test
meshes_NavierStokes_test : $(NAVIERSTOKES_TEST)
$(NAVIERSTOKES_TEST) :
	cd $(PYTHONDIR) && $(PYTHONC) $(SOURCE) NavierStokes_test $@
